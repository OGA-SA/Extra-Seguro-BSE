<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FORMULARIO EXTRA SEGURO</title>
  <link rel="stylesheet" href="estilo.css" />
</head>
<body>
  <div id="escalado">
    <div id="contenidoPDF">
      <div class="header">
        <img src="Cars.JPG" alt="Logo Cars" class="logo" />
      </div>
      <h2>FORMULARIO EXTRA SEGURO</h2>

      <div class="datos">
        <div class="contenedor-izquierda">
          <form id="dataForm">
            <div class="fila-formulario">
              <div class="form-group">
                <label><span>Taller NÂ°:</span> <input type="text" id="taller" required /></label>
                <label><span>Serie y NÂ°:</span> <input type="text" id="serieNumero" required /></label>
              </div>
            </div>
          </form>

          <div class="imagen-y-campos">
            <div class="canvas-section">
              <canvas id="canvas" width="700" height="350"></canvas>
              <button class="clear-button" type="button" onclick="clearCanvas()">Limpiar Dibujo</button>
            </div>
          </div>
        </div>

        <form class="columna-derecha">
          <div class="fecha">
            <label class="Fecha"><span>Fecha:</span> <input type="date" id="fecha" required /></label>
          </div>
          <div class="stro">
            <label class="siniestro"> 
                <span>Siniestro:</span>
                <input type="text" id="siniestro1" required />
              
                <span>-</span>
              
                <span>AÃ±o:</span>
                <input type="text" id="siniestro2" 
                       min="1900" max="2100" 
                       required  
                       placeholder="XXXX" 
                       title="Debe ingresar el aÃ±o completo con 4 dÃ­gitos (ej: 2025)"
                       pattern="\d{4}" />
            </label>
            <label class="visual"><span>Â¿Dificulta visual?:</span> <input type="text" id="dificultadVisual" /></label>
          </div>
        </form>
      </div>

      <div class="texto">
        <h3>SE INFORMAN RUBROS CUYOS PORCENTAJES NO SE TENDRAN EN CUENTA EN FUTURAS RECLAMACIONES</h3>
        <h3>ANULA / REMPLAZA EXTRA SEGURO DE FECHA:</h3>
      </div>

      <div class="tablas-piezas">
        <table id="tablaPiezas1">
        <thead>
          <tr>
            <th>PIEZA / ACCESORIOS</th>
            <th>CHAPA</th>
            <th>PINTURA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>GUARDABARRO DEL DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO DEL IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>CARETA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARAGOLPE DELANTERO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ESPEJO DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ESPEJO IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>SEMIOPTICA DERECHA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>SEMIOPTICA IZQUIERDA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA DELANTERA DERECHA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA DELANTERA IZQUIERDA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA TRASERA DERECHA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA TRASERA IZQUIERDA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PORTON TRAS DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PORTON TRAS IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td><input class="autocomplete" type="text" autocomplete="off" spellcheck="false" placeholder=""/></td><td><input type="text"/></td><td><input type="text" /></td></tr>
        </tbody>
      </table>

      <table id="tablaPiezas2">
        <thead>
          <tr>
            <th>PIEZA / ACCESORIOS</th>
            <th>CHAPA</th>
            <th>PINTURA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>ESPOLON</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO TRAS DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO TRAS IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>TECHO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARABRISAS</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PANEL TRASERO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>TAPA VALIJA / PORTON TRAS.</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARAGOLPE TRASERO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ZOCALO DERECHO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ZOCALO IZQUIERDO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>LATERAL DERECHO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>LATERAL IZQUIERDO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>FARO TRAS DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>FARO TRAS IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text"/></td><td><input type="text" /></td></tr>
        </tbody>
      </table>
      
      </div>
      
       <div class="firma">
              <label><span>POR CARS:</span> <input type="text" id="QUIEN" required /></label>
                   </div>
      
              <form id="boton">
                <div style="text-align: center; margin: 30px 0;">
                    <button class="boton" onclick="generarPDF()">Generar PDF</button>
                </div>
        
        </form>
      
    </div>
    
  </div>
<!-- LibrerÃ­as necesarias -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://graph.microsoft.com/v1.0/me/drive/root:/Extra Seguro/miArchivo.pdf:/content"></script>

<!-- Loader dinÃ¡mico de MSAL -->
<script>
(function () {
  const candidates = [
    "https://alcdn.msauth.net/browser/2.45.0/js/msal-browser.min.js",
    "https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.45.0/lib/msal-browser.min.js",
    "https://unpkg.com/@azure/msal-browser@2.45.0/lib/msal-browser.min.js"
  ];

  function loadScript(url) {
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      s.onload = () => resolve(url);
      s.onerror = () => reject(url);
      document.head.appendChild(s);
    });
  }

  async function ensureMsal() {
    if (window.msal) return "preloaded";
    for (const url of candidates) {
      try {
        await loadScript(url);
        if (window.msal) {
          console.log("âœ… MSAL cargado desde:", url);
          return url;
        }
      } catch (e) {
        console.warn("No se pudo cargar MSAL desde:", url);
      }
    }
    throw new Error("MSAL no se pudo cargar desde ningÃºn CDN.");
  }

  window.ensureMsal = ensureMsal;
})();
</script>

<!-- Ajuste dinÃ¡mico de input -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("text");
  if (!input) return;

  input.addEventListener("input", function() {
    const span = document.createElement("span");
    span.style.visibility = "hidden";
    span.style.position = "absolute";
    span.style.whiteSpace = "pre";
    span.style.font = window.getComputedStyle(input).font;

    span.textContent = input.value || input.placeholder;

    document.body.appendChild(span);
    const ancho = span.offsetWidth + 10;
    document.body.removeChild(span);

    input.style.width = ancho + "px";
  });
});
</script>

<!-- Canvas con parabrisas -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("canvas");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  let baseImageData = null;
  window.userHasDrawn = false;

  const image = new Image();
  image.src = "parabrisa.png";
  image.onload = () => {
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  };

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    window.userHasDrawn = false;
    baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  }
  window.clearCanvas = clearCanvas;

  let drawing = false;

  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    const escalaX = canvas.width / rect.width;
    const escalaY = canvas.height / rect.height;
    const x = evt.touches ? (evt.touches[0].clientX - rect.left) * escalaX : (evt.clientX - rect.left) * escalaX;
    const y = evt.touches ? (evt.touches[0].clientY - rect.top) * escalaY : (evt.clientY - rect.top) * escalaY;
    return { x, y };
  }

  function startDraw(evt) {
    evt.preventDefault();
    drawing = true;
    const pos = getPos(evt);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(evt) {
    if (!drawing) return;
    evt.preventDefault();
    const pos = getPos(evt);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "red";
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    window.userHasDrawn = true;
  }

  function endDraw(evt) {
    evt.preventDefault();
    drawing = false;
    ctx.beginPath();
  }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);
  canvas.addEventListener("touchstart", startDraw, { passive: false });
  canvas.addEventListener("touchmove", draw, { passive: false });
  canvas.addEventListener("touchend", endDraw);
  canvas.addEventListener("touchcancel", endDraw);
});
</script>

<!-- Autocompletar + autofila -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const sugerencias = [
    "PUNTERA P/GOLPE DEL DER", "PUNTERA P/GOLPE DEL IZQ", "SEÃ‘ALERO DEL DER",
    "SEÃ‘ALERO DEL IZQ", "PUNTERA P/GOLPE TRAS DER", "PUNTERA P/GOLPE TRAS IZQ",
    "LUNETA TRASERA", "MOLDURA sup tapa caja", "FRENTE DE CHAPA",
    "PORTON LATERAL DERECHO", "CHORIZO DE TECHO IZQ"
  ];

  function aplicarAutocompletado(inputAuto) {
    let ultimaEntrada = "";
    inputAuto.addEventListener("input", () => {
      const valor = inputAuto.value.toLowerCase();
      if (valor.length < ultimaEntrada.length) {
        ultimaEntrada = valor;
        return;
      }
      const match = sugerencias.find(opcion => opcion.toLowerCase().startsWith(valor));
      if (match && valor !== match.toLowerCase()) {
        inputAuto.value = match;
        inputAuto.setSelectionRange(valor.length, match.length);
      }
      ultimaEntrada = valor;
    });
  }

  document.querySelectorAll(".autocomplete").forEach(aplicarAutocompletado);

  function agregarFilaSiEsUltima(input, tablaId) {
    const tabla = document.getElementById(tablaId);
    const filas = tabla.querySelectorAll("tbody tr");
    const ultimaFila = filas[filas.length - 1];

    if (ultimaFila.contains(input)) {
      const nuevaFila = ultimaFila.cloneNode(true);
      nuevaFila.querySelectorAll("input").forEach(input => {
        input.value = "";
        input.classList.add("nuevo");
        if (!input.classList.contains("autocomplete")) input.classList.add("autocomplete");
      });
      tabla.querySelector("tbody").appendChild(nuevaFila);
      nuevaFila.querySelectorAll(".autocomplete").forEach(aplicarAutocompletado);
    }
  }

  function inicializarAutofila(tablaId) {
    const tabla = document.getElementById(tablaId);
    tabla.addEventListener("input", function (e) {
      if (e.target.tagName === "INPUT") agregarFilaSiEsUltima(e.target, tablaId);
    });
  }

  inicializarAutofila("tablaPiezas1");
  inicializarAutofila("tablaPiezas2");
});
</script>

<!-- Canvas "POR CARS:" -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("canvas1");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  function drawLabel() {
    const texto = "POR CARS:";
    ctx.font = "16px sans-serif";
    ctx.fillStyle = "#333";
    const y = canvas.height - 20;
    const startX = 10;
    const textWidth = ctx.measureText(texto).width;
    const lineY = y + 4;
    ctx.fillText(texto, startX, y);
    ctx.beginPath();
    ctx.moveTo(startX + textWidth + 8, lineY);
    ctx.lineTo(canvas.width - 10, lineY);
    ctx.lineWidth = 1.5;
    ctx.strokeStyle = "#333";
    ctx.stroke();
  }

  function initCanvas() {
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    drawLabel();
  }

  function clearCanvas1() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    drawLabel();
  }
  window.clearCanvas1 = clearCanvas1;

  let drawing = false;
  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    const escalaX = canvas.width / rect.width;
    const escalaY = canvas.height / rect.height;
    const x = evt.touches ? (evt.touches[0].clientX - rect.left) * escalaX : (evt.clientX - rect.left) * escalaX;
    const y = evt.touches ? (evt.touches[0].clientY - rect.top) * escalaY : (evt.clientY - rect.top) * escalaY;
    return { x, y };
  }
  function startDraw(evt) { evt.preventDefault(); drawing = true; const pos = getPos(evt); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
  function draw(evt) { if (!drawing) return; evt.preventDefault(); const pos = getPos(evt); ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "black"; ctx.lineTo(pos.x, pos.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
  function endDraw(evt) { evt.preventDefault(); drawing = false; ctx.beginPath(); }

  ["mousedown","mousemove","mouseup","mouseleave"].forEach(e => canvas.addEventListener(e, {mousedown:startDraw, mousemove:draw, mouseup:endDraw, mouseleave:endDraw}[e]));
  ["touchstart","touchmove","touchend","touchcancel"].forEach(e => canvas.addEventListener(e, {touchstart:startDraw, touchmove:draw, touchend:endDraw, touchcancel:endDraw}[e], {passive:false}));

  initCanvas();
});
</script>

<!-- Escalado automÃ¡tico -->
<script>
function escalarPagina() {
  const baseWidth = 1200;
  const escala = Math.min(window.innerWidth / baseWidth, 1);
  const escalado = document.getElementById('escalado');
  if (!escalado) return;
  escalado.style.transform = `scale(${escala})`;
  escalado.style.transformOrigin = 'top center';
  document.body.style.height = `${escalado.getBoundingClientRect().height}px`;
}
window.addEventListener('resize', escalarPagina);
window.addEventListener('load', escalarPagina);
</script>

<!-- MSAL + GeneraciÃ³n y subida PDF con eliminaciÃ³n de Ãºltima fila vacÃ­a -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const boton = document.querySelector("#boton .boton"); 
  if (!boton) return;

  // ðŸ”¹ FunciÃ³n: eliminar Ãºltima fila vacÃ­a solo para PDF
  function eliminarUltimaFilaVacia(tablaId) {
    const tabla = document.getElementById(tablaId);
    if (!tabla) return;
    const filas = tabla.querySelectorAll("tbody tr");
    if (!filas.length) return;
    const ultimaFila = filas[filas.length - 1];
    const inputs = ultimaFila.querySelectorAll("input");
    let vacia = true;
    inputs.forEach(input => { if (input.value.trim() !== "") vacia = false; });
    if (vacia) ultimaFila.remove();
 

</script>
</body>
</html>
